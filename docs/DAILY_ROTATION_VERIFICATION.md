# 日期轮转功能验证文档

## 实现说明

已实现主应用日志按日期分割功能，主要更改：

### 1. 新增文件

**`internal/logging/daily_rotate.go`**
- 实现 `dailyRotateWriter` 结构体，包装 `lumberjack.Logger`
- 在每次 `Write()` 时检查日期是否变化
- 自动关闭旧日志文件，创建新日期的日志文件
- 线程安全（使用 `sync.Mutex`）

### 2. 修改文件

**`internal/logging/logging.go`**
- 将 `lumberjack.Logger` 替换为 `dailyRotateWriter`
- 移除直接的时间处理逻辑（现在由 `dailyRotateWriter` 管理）
- 简化 `NewLogger` 函数

## 功能验证

### 自动化测试

```bash
# 运行单元测试
go test -v ./internal/logging/
```

### 手动测试（基础功能）

```powershell
# 运行测试脚本
powershell -ExecutionPolicy Bypass -File test_daily_rotation.ps1
```

**预期结果：**
- 创建日志文件：`logs\app-2026-02-19.log`
- 日志格式：`2026-02-19 11:13:35.606 - [INFO]: 消息`

### 跨天轮转测试

#### 方法 1：修改系统时间

1. **启动应用**
   ```powershell
   .\nanobot-auto-updater.exe
   ```

2. **修改系统时间到第二天**
   - Windows 设置 > 时间和语言 > 日期和时间
   - 关闭"自动设置时间"
   - 手动修改日期到明天

3. **观察日志文件**
   - 应该自动创建新日期的日志文件
   - 旧日志文件保持不变
   - 新日志写入新文件

4. **恢复系统时间**

#### 方法 2：自然跨天（长期运行测试）

1. **在跨天前启动应用**
   ```powershell
   # 例如在 23:50 启动
   .\nanobot-auto-updater.exe
   ```

2. **等待跨天**
   - 应用在 00:00 后写入日志时自动切换文件

3. **验证结果**
   - 检查是否创建了新日期的日志文件
   - 旧文件最后一条日志应该是昨天的日期
   - 新文件第一条日志应该是今天的日期

### 验证清单

- [x] 日志文件按日期命名：`app-YYYY-MM-DD.log`
- [x] 日志格式正确：`YYYY-MM-DD HH:MM:SS.mmm - [LEVEL]: 消息`
- [x] 日志同时输出到文件和标准输出
- [x] 单元测试通过
- [x] 编译成功
- [ ] 跨天自动创建新文件（需手动测试）
- [ ] 旧文件保持完整（需手动测试）
- [ ] 长期运行稳定性（需生产环境验证）

## 技术细节

### 实现原理

1. **延迟轮转**：不是定时器轮询，而是在每次写日志时检查日期
2. **性能优化**：只在日期变化时才进行文件操作
3. **错误处理**：轮转失败时记录警告，继续使用旧文件
4. **线程安全**：使用互斥锁保护日期检查和文件切换

### 与调度器日志的区别

| 特性 | 主应用日志 | 调度器日志 |
|------|-----------|-----------|
| 位置 | `logs/app-YYYY-MM-DD.log` | `internal/scheduler/logs/app-YYYY-MM-DD.log` |
| 轮转方式 | 动态日期检查 | 每次调度重新初始化 |
| 适用场景 | 长期运行的守护进程 | 短期调度任务 |

## 故障排查

### 问题：日志没有按日期分割

**检查项：**
1. 确认使用的是新编译的 `nanobot-auto-updater.exe`
2. 查看日志文件修改时间，确认应用在运行
3. 检查系统时间是否正确

### 问题：跨天后仍然写入旧文件

**可能原因：**
1. 应用在跨天时没有写入日志（没有触发 `Write()` 检查）
2. 系统时间未正确更新
3. 文件权限问题

**解决方法：**
- 重启应用，强制创建新日期文件
- 检查文件权限和磁盘空间

## 维护说明

- **日志保留期**：7 天（`MaxAge: 7`）
- **单文件大小限制**：50 MB（`MaxSize: 50`）
- **备份文件数**：每天最多 3 个备份文件（`MaxBackups: 3`）

修改配置请编辑 `internal/logging/daily_rotate.go` 中的常量。
