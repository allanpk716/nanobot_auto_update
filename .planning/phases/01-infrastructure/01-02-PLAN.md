---
phase: 01-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/config/config.go
  - go.mod
autonomous: true
requirements:
  - INFR-03
  - INFR-04

must_haves:
  truths:
    - "Configuration is loaded from ./config.yaml by default"
    - "Config struct contains Cron field with default value '0 3 * * *'"
    - "Cron expressions are validated at config load time"
    - "Invalid cron expressions cause clear error message"
  artifacts:
    - path: "internal/config/config.go"
      provides: "Extended configuration with Cron field and loader"
      exports:
        - "Config"
        - "Load"
        - "ValidateCron"
      min_lines: 80
    - path: "go.mod"
      provides: "Dependency declarations"
      contains: "robfig/cron"
  key_links:
    - from: "internal/config/config.go"
      to: "github.com/robfig/cron/v3"
      via: "import"
      pattern: "cron\\.NewParser"
    - from: "internal/config/config.go"
      to: "github.com/spf13/viper"
      via: "import"
      pattern: "viper\\."
---

<objective>
Extend the configuration system to support YAML file loading, cron field with validation, and viper integration.

Purpose: Enable configuration loading from YAML files with cron expression support and early validation.
Output: Extended `internal/config/config.go` with Load function, Cron field, and ValidateCron helper.
</objective>

<execution_context>
@C:/Users/allan716/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/allan716/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/1-RESEARCH.md

# Existing config to extend
@internal/config/config.go - Existing Config and NanobotConfig structs

# RESEARCH patterns to follow
- Use viper.SetConfigFile for explicit file path
- Use viper.SetDefault for default values
- Use mapstructure tags for viper.Unmarshal
- Use robfig/cron/v3 parser for validation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config dependencies to go.mod</name>
  <files>go.mod</files>
  <action>
Add the following dependencies using `go get`:

1. `github.com/spf13/viper` - For YAML configuration loading
2. `github.com/robfig/cron/v3` - For cron expression validation
3. `github.com/mitchellh/mapstructure` - For struct unmarshaling (viper dependency)

Run:
```bash
go get github.com/spf13/viper@latest
go get github.com/robfig/cron/v3@latest
go get github.com/mitchellh/mapstructure@latest
```

This will update go.mod and go.sum with the required dependencies.
  </action>
  <verify>
```bash
grep -E "(viper|cron)" go.mod
```
Should show both viper and cron in require section.
  </verify>
  <done>go.mod contains viper, cron/v3, and mapstructure dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Extend Config struct and add Load function</name>
  <files>internal/config/config.go</files>
  <action>
Extend `internal/config/config.go` with:

1. Add Cron field to Config struct:
```go
type Config struct {
    Cron    string        `yaml:"cron" mapstructure:"cron"`
    Nanobot NanobotConfig `yaml:"nanobot" mapstructure:"nanobot"`
}
```

2. Update defaults() to set Cron default:
```go
c.Cron = "0 3 * * *"
```

3. Add ValidateCron function:
```go
// ValidateCron validates a cron expression.
func ValidateCron(expr string) error {
    parser := cron.NewParser(cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow)
    _, err := parser.Parse(expr)
    if err != nil {
        return fmt.Errorf("invalid cron expression %q: %w", expr, err)
    }
    return nil
}
```

4. Update Validate() to check Cron:
```go
func (c *Config) Validate() error {
    if err := ValidateCron(c.Cron); err != nil {
        return err
    }
    return c.Nanobot.Validate()
}
```

5. Add Load function:
```go
import (
    "github.com/spf13/viper"
)

var (
    ErrHelpRequested    = errors.New("help requested")
    ErrVersionRequested = errors.New("version requested")
)

// Load reads configuration from the specified YAML file.
// Returns Config with defaults applied, then file values, then validation.
func Load(configPath string) (*Config, error) {
    v := viper.New()
    v.SetConfigFile(configPath)
    v.SetConfigType("yaml")

    // Create config with defaults
    cfg := New()

    // Set defaults in viper (for fields not in file)
    v.SetDefault("cron", cfg.Cron)
    v.SetDefault("nanobot.port", cfg.Nanobot.Port)
    v.SetDefault("nanobot.startup_timeout", cfg.Nanobot.StartupTimeout.String())

    // Read config file (optional - use defaults if missing)
    if err := v.ReadInConfig(); err != nil {
        // If file doesn't exist, use defaults
        if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
            return nil, fmt.Errorf("failed to read config file: %w", err)
        }
        // File not found is OK, use defaults
    }

    // Unmarshal to struct
    if err := v.Unmarshal(cfg); err != nil {
        return nil, fmt.Errorf("failed to unmarshal config: %w", err)
    }

    // Validate
    if err := cfg.Validate(); err != nil {
        return nil, fmt.Errorf("config validation failed: %w", err)
    }

    return cfg, nil
}
```

Key implementation notes:
- Import errors package for sentinel errors
- Import time for Duration parsing
- Use viper.New() for clean instance (not global viper)
- Set defaults BEFORE reading config
- File not found is OK (use defaults)
- Always validate after loading

Add required imports:
- errors
- fmt
- time
- github.com/robfig/cron/v3
- github.com/spf13/viper
  </action>
  <verify>
```bash
go build ./internal/config/...
```
Should compile without errors.
  </verify>
  <done>internal/config/config.go has Cron field, Load function, and ValidateCron helper.</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for config loading</name>
  <files>internal/config/config_test.go</files>
  <action>
Create `internal/config/config_test.go` with tests for:

1. TestNewConfigDefaults - Verify New() returns config with correct defaults:
   - Cron = "0 3 * * *"
   - Nanobot.Port = 18790
   - Nanobot.StartupTimeout = 30s

2. TestValidateCronValid - Test valid cron expressions:
   - "0 3 * * *"
   - "*/5 * * * *"
   - "0 0 1 1 *"

3. TestValidateCronInvalid - Test invalid cron expressions:
   - "invalid"
   - "* * * *" (missing field)
   - Empty string should fail

4. TestConfigValidation - Verify Config.Validate():
   - Valid config passes
   - Invalid cron fails

Run tests with:
```bash
go test ./internal/config/... -v
```
  </action>
  <verify>
```bash
go test ./internal/config/... -v
```
All tests pass.
  </verify>
  <done>Test file exists and all tests pass, confirming config loading and validation work correctly.</done>
</task>

</tasks>

<verification>
1. Run `go build ./...` to ensure all code compiles
2. Run `go test ./internal/config/... -v` to verify config loading
3. Check that internal/config/config.go exports Load, Config with Cron, and ValidateCron
4. Verify go.mod contains viper and cron dependencies
</verification>

<success_criteria>
- internal/config/config.go compiles and passes tests
- Config struct has Cron field with default "0 3 * * *"
- Load function reads YAML config file
- ValidateCron validates cron expressions
- Invalid cron expressions cause clear error
- File not found uses defaults (non-fatal)
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-02-SUMMARY.md`
</output>
