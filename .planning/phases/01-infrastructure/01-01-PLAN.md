---
phase: 01-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/logging/logging.go
  - go.mod
autonomous: true
requirements:
  - INFR-01
  - INFR-02

must_haves:
  truths:
    - "Logs are written to ./logs/app.log with rotation"
    - "Log format is '2024-01-01 12:00:00.123 - [INFO]: message'"
    - "Log files older than 7 days are automatically deleted"
    - "Logger outputs to both file and stdout simultaneously"
  artifacts:
    - path: "internal/logging/logging.go"
      provides: "Structured logging with file rotation"
      exports:
        - "NewLogger"
      min_lines: 50
    - path: "go.mod"
      provides: "Dependency declarations"
      contains: "lumberjack"
  key_links:
    - from: "internal/logging/logging.go"
      to: "gopkg.in/natefinch/lumberjack.v2"
      via: "import"
      pattern: "lumberjack\\.Logger"
    - from: "internal/logging/logging.go"
      to: "log/slog"
      via: "import"
      pattern: "slog\\.New"
---

<objective>
Create a structured logging module with custom format and file rotation.

Purpose: Establish the foundation for application logging with the required format and automatic log file management.
Output: `internal/logging/logging.go` with NewLogger function that creates a slog.Logger with lumberjack rotation.
</objective>

<execution_context>
@C:/Users/allan716/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/allan716/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/1-RESEARCH.md

# Existing patterns to follow
@internal/config/config.go - Shows Config pattern with defaults() and Validate()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add logging dependencies to go.mod</name>
  <files>go.mod</files>
  <action>
Add the following dependencies using `go get`:

1. `gopkg.in/natefinch/lumberjack.v2` - For log file rotation

Run:
```bash
go get gopkg.in/natefinch/lumberjack.v2
```

This will update go.mod and go.sum with the required dependencies.
  </action>
  <verify>
```bash
grep lumberjack go.mod
```
Should show lumberjack in require section.
  </verify>
  <done>go.mod contains lumberjack.v2 dependency, go.sum is updated with checksums.</done>
</task>

<task type="auto">
  <name>Task 2: Create logging package with custom format</name>
  <files>internal/logging/logging.go</files>
  <action>
Create `internal/logging/logging.go` with the following implementation:

1. Package: `logging`
2. Function signature: `NewLogger(logDir string) *slog.Logger`
3. Requirements:
   - Create log directory if it doesn't exist (os.MkdirAll with 0755)
   - Use lumberjack.Logger with:
     - Filename: `logDir + "/app.log"`
     - MaxSize: 50 (MB - triggers rotation at reasonable size)
     - MaxBackups: 3 (keep 3 old files)
     - MaxAge: 7 (days - retention)
     - Compress: false
     - LocalTime: true
   - Use slog.TextHandler with custom ReplaceAttr for format:
     - Time format: "2006-01-02 15:04:05.000" (millisecond precision)
     - Level format: "[INFO]", "[WARN]", "[ERROR]" (bracketed, uppercase)
   - Use io.MultiWriter to output to both file AND stdout

Key implementation notes from RESEARCH.md:
- Use slog.HandlerOptions with ReplaceAttr function
- TimeKey replacement: format with t.Format("2006-01-02 15:04:05.000")
- LevelKey replacement: format as fmt.Sprintf("[%s]", level.String())
- DO NOT write custom handler - use TextHandler with ReplaceAttr

Imports needed:
- io
- log/slog
- os
- time
- gopkg.in/natefinch/lumberjack.v2
  </action>
  <verify>
```bash
go build ./internal/logging/...
```
Should compile without errors.
  </verify>
  <done>internal/logging/logging.go exists with NewLogger function that returns *slog.Logger with custom format and rotation.</done>
</task>

<task type="auto">
  <name>Task 3: Verify logging output format</name>
  <files>internal/logging/logging_test.go</files>
  <action>
Create a simple test file `internal/logging/logging_test.go` to verify:

1. NewLogger creates a non-nil logger
2. Calling logger.Info() produces output containing the expected format

Test should:
- Create a temp directory for logs
- Call NewLogger(tempDir)
- Log a test message with logger.Info("test message", "key", "value")
- Verify the output contains:
  - Timestamp in format "2006-01-02 15:04:05"
  - "[INFO]" level marker
  - "test message"

Run test with:
```bash
go test ./internal/logging/... -v
```
  </action>
  <verify>
```bash
go test ./internal/logging/... -v
```
Tests pass.
  </verify>
  <done>Test file exists and passes, confirming logger produces correct format.</done>
</task>

</tasks>

<verification>
1. Run `go build ./...` to ensure all code compiles
2. Run `go test ./internal/logging/... -v` to verify format
3. Check that internal/logging/logging.go exports NewLogger function
4. Verify go.mod contains lumberjack dependency
</verification>

<success_criteria>
- internal/logging/logging.go exists and compiles
- NewLogger function creates logger with custom format
- Log format matches: "2024-01-01 12:00:00.123 - [INFO]: message" (with milliseconds and bracketed level)
- Lumberjack configured for 7-day retention
- Log directory created automatically
- Logger outputs to both file and stdout
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-01-SUMMARY.md`
</output>
