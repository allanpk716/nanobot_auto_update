---
phase: 01-infrastructure
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/logging/logging.go
  - internal/logging/logging_test.go
autonomous: true
requirements:
  - INFR-01
gap_closure: true

must_haves:
  truths:
    - "Log format exactly matches '2024-01-01 12:00:00.123 - [INFO]: message'"
    - "Timestamp has millisecond precision"
    - "Level markers are bracketed and uppercase"
  artifacts:
    - path: "internal/logging/logging.go"
      provides: "Custom slog.Handler with simple format output"
      exports: ["NewLogger"]
    - path: "internal/logging/logging_test.go"
      provides: "Format verification tests"
      contains: "TestLoggerFormat"
  key_links:
    - from: "internal/logging/logging.go"
      to: "log/slog"
      via: "slog.Handler interface implementation"
      pattern: "type simpleHandler struct"
---

<objective>
Fix log format to output exactly as specified: "2024-01-01 12:00:00.123 - [INFO]: message"

Purpose: The current slog.TextHandler outputs key=value format (time=... level=... msg=...) which doesn't match the required simple format. INFR-01 specifies exact format for consistency with log parsing tools.

Output: Custom slog.Handler implementation that outputs simple format without key= prefixes.
</objective>

<execution_context>
@C:/Users/allan716/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/allan716/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/logging/logging.go
@internal/lifecycle/starter.go
</context>

<tasks>

<task type="auto">
  <name>Implement custom simpleHandler for exact log format</name>
  <files>internal/logging/logging.go</files>
  <action>
    Replace the slog.TextHandler with a custom slog.Handler implementation that outputs the exact format: "2006-01-02 15:04:05.000 - [LEVEL]: message"

    Requirements:
    1. Create a `simpleHandler` struct that implements slog.Handler interface
    2. Implement Enabled() - always return true
    3. Implement Handle() - write formatted output directly to io.Writer:
       - Format: "2006-01-02 15:04:05.000 - [LEVEL]: message\n"
       - Level must be bracketed and uppercase: [INFO], [WARN], [ERROR], [DEBUG]
       - Timestamp must have millisecond precision
    4. Implement WithAttrs() - return new handler with attributes (store for future use if needed)
    5. Implement WithGroup() - return self (groups not needed for simple format)

    Implementation details:
    - Use record.Time.Format("2006-01-02 15:04:05.000") for timestamp
    - Use record.Level.String() and wrap in brackets for level
    - Use record.Message for the message
    - Write to the handler's writer using fmt.Fprintf

    Keep the existing lumberjack configuration and io.MultiWriter setup - only replace the handler creation from slog.NewTextHandler to slog.New(&simpleHandler{...}).

    DO NOT use slog.TextHandler with ReplaceAttr - it cannot remove the key= prefixes.
    DO use a custom handler that writes the exact format directly.
  </action>
  <verify>
    Run the program and check log output format:
    ```
    go run ./cmd/main.go --run-once 2>&1 | head -5
    ```
    Expected format: "2024-01-01 12:00:00.123 - [INFO]: message"
    Actual should NOT contain "time=", "level=", "msg=" prefixes.
  </verify>
  <done>
    Log output matches exact format "2006-01-02 15:04:05.000 - [LEVEL]: message" without key=value prefixes.
  </done>
</task>

<task type="auto">
  <name>Update logging tests for exact format verification</name>
  <files>internal/logging/logging_test.go</files>
  <action>
    Update TestLoggerFormat to verify the exact output format:
    1. Capture log output to a bytes.Buffer
    2. Verify the output matches regex: `^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3} - \[(DEBUG|INFO|WARN|ERROR)\]: .+$`
    3. Verify NO key=value prefixes exist in output (no "time=", "level=", "msg=")
    4. Test all four log levels: Debug, Info, Warn, Error

    The test should explicitly verify:
    - Timestamp format: YYYY-MM-DD HH:MM:SS.mmm
    - Separator: " - " (space dash space)
    - Level format: [LEVEL] with brackets
    - Message separator: ": " (colon space)
    - NO "time=", "level=", "msg=" prefixes
  </action>
  <verify>
    Run tests:
    ```
    go test ./internal/logging/ -v
    ```
    All tests pass including format verification.
  </verify>
  <done>
    Tests verify exact log format matches "2006-01-02 15:04:05.000 - [LEVEL]: message" specification.
  </done>
</task>

</tasks>

<verification>
Verify the gap is closed by running:
1. `go test ./internal/logging/ -v` - all tests pass
2. `go run ./cmd/main.go --run-once 2>&1 | head -1` - output matches "YYYY-MM-DD HH:MM:SS.mmm - [LEVEL]: message"
3. Grep for "time=" in log output should return nothing
</verification>

<success_criteria>
- Log format exactly matches "2024-01-01 12:00:00.123 - [INFO]: message"
- No "time=", "level=", "msg=" prefixes in log output
- All existing functionality preserved (file rotation, stdout output, millisecond precision)
- Tests pass and verify exact format
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-04-SUMMARY.md`
</output>
