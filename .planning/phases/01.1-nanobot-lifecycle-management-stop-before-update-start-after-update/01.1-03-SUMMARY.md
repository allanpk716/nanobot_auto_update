---
phase: 01.1-nanobot-lifecycle-management-stop-before-update-start-after-update
plan: 03
subsystem: lifecycle
tags: [lifecycle-manager, orchestration, config-validation, stop-start-coordination]

# Dependency graph
requires:
  - phase: 01.1-01
    provides: Port detection via IsNanobotRunning
  - phase: 01.1-02
    provides: StopNanobot and StartNanobot implementations
provides:
  - Lifecycle Manager struct coordinating stop-start sequence
  - StopForUpdate method (cancels update on failure)
  - StartAfterUpdate method (logs warning on failure, update succeeds)
  - Integration with existing NanobotConfig validation
affects: [updater, main-orchestrator]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Lifecycle orchestration pattern
    - Error propagation for critical vs non-critical operations

key-files:
  created:
    - internal/lifecycle/manager.go
  modified: []

key-decisions:
  - "Stop failure cancels update (returns error)"
  - "Start failure logs warning but update succeeds (returns error for caller to log)"
  - "Always start nanobot after update regardless of previous state"
  - "Stop timeout fixed at 5 seconds (not configurable)"

patterns-established:
  - "Manager pattern for coordinating lifecycle operations"
  - "Context propagation for timeout and cancellation"
  - "Config validation pattern with early defaults then validation"

requirements-completed:
  - IMPL-01
  - IMPL-02
  - IMPL-03
  - IMPL-04

# Metrics
duration: 2 min
completed: 2026-02-18
---

# Phase 01.1 Plan 03: Lifecycle Manager Summary

**Lifecycle manager orchestrating stop-before-update-start-after-update sequence with config validation integration**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-18T05:12:59Z
- **Completed:** 2026-02-18T05:15:45Z
- **Tasks:** 2
- **Files modified:** 1

## Accomplishments
- Created Manager struct that coordinates stop-start lifecycle sequence
- Implemented StopForUpdate that cancels update on stop failure (critical operation)
- Implemented StartAfterUpdate that logs warning on start failure (non-critical operation)
- Verified NanobotConfig.Validate() integration for port and timeout validation

## Task Commits

Each task was committed atomically:

1. **Task 1: Create lifecycle manager orchestrating stop/start** - `c4d71c9` (feat)
2. **Task 2: Integrate nanobot config validation** - No commit needed (already implemented in prior plan)

## Files Created/Modified
- `internal/lifecycle/manager.go` - Lifecycle Manager with StopForUpdate and StartAfterUpdate methods coordinating detector, stopper, and starter packages

## Decisions Made

All decisions follow locked decisions from CONTEXT.md:
- Stop failure returns error and cancels the update
- Start failure returns error but update is still successful (caller logs warning)
- Nanobot is always started after update regardless of previous running state
- Stop timeout is fixed at 5 seconds (not user-configurable)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

Task 2 (config validation integration) was already implemented in a prior plan (01.1-01 or 01.1-02). The NanobotConfig.Validate() method exists and is called by Config.Validate() with all required checks (Port validation and StartupTimeout minimum). No additional implementation needed.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Lifecycle infrastructure complete. Ready for integration with updater logic that will use Manager.StopForUpdate() before update and Manager.StartAfterUpdate() after update. All core lifecycle operations (detect, stop, start, orchestrate) are implemented and validated.

---
*Phase: 01.1-nanobot-lifecycle-management-stop-before-update-start-after-update*
*Completed: 2026-02-18*

## Self-Check: PASSED
- internal/lifecycle/manager.go exists on disk
- Task commit c4d71c9 found in git history
