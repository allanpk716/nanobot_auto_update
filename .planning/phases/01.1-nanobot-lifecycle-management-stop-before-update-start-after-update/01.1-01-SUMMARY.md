---
phase: 01.1-nanobot-lifecycle-management-stop-before-update-start-after-update
plan: 01
subsystem: lifecycle
tags: [gopsutil, config, process-detection, port-monitoring]

# Dependency graph
requires: []
provides:
  - NanobotConfig struct with Port and StartupTimeout fields
  - Port-based process detection via gopsutil
  - FindPIDByPort and IsNanobotRunning functions
affects: [lifecycle, nanobot-update]

# Tech tracking
tech-stack:
  added: [github.com/shirou/gopsutil/v3, golang.org/x/sys/windows]
  patterns: [windows-build-constraints, config-validation]

key-files:
  created:
    - internal/config/config.go
    - internal/lifecycle/detector.go
    - config.yaml
  modified: []

key-decisions:
  - "Used gopsutil/net for port detection instead of fragile netstat parsing"
  - "Added Windows build constraints to lifecycle package"

patterns-established:
  - "go:build windows constraint for Windows-specific code"
  - "Config struct pattern with defaults() and Validate() methods"

requirements-completed: [IMPL-01]

# Metrics
duration: 4min
completed: 2026-02-18
---

# Phase 01.1 Plan 01: Nanobot Lifecycle Configuration and Detection Summary

**Port-based nanobot process detection using gopsutil with configurable port (default 18790) and startup timeout (default 30s)**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-18T05:00:38Z
- **Completed:** 2026-02-18T05:04:30Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Added NanobotConfig struct with Port (uint32) and StartupTimeout (time.Duration) fields
- Implemented port-based process detection using gopsutil/net library
- Created FindPIDByPort function to find process listening on a specific port
- Created IsNanobotRunning function to check nanobot running status

## Task Commits

Each task was committed atomically:

1. **Task 1: Add NanobotConfig to configuration** - `4330943` (feat)
2. **Task 2: Implement port-based process detection** - `f068ba1` (feat)

**Additional fix:** `930c496` (fix) - Fixed Windows build constraint for existing stopper.go

## Files Created/Modified
- `internal/config/config.go` - NanobotConfig struct with Port, StartupTimeout, Validate methods
- `internal/lifecycle/detector.go` - FindPIDByPort and IsNanobotRunning functions using gopsutil
- `config.yaml` - nanobot configuration section with port and startup_timeout
- `go.mod` / `go.sum` - Added gopsutil and x/sys/windows dependencies

## Decisions Made
- Used gopsutil/v3/net for port detection instead of parsing netstat output (more reliable, cross-platform potential)
- Added go:build windows constraint to ensure Windows-specific code only compiles on Windows

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking Issue] Fixed Windows build constraint for existing stopper.go**
- **Found during:** Task 1 (configuration build verification)
- **Issue:** Pre-existing internal/lifecycle/stopper.go used undefined syscall.CREATE_NO_WINDOW constant
- **Fix:** Added go:build windows constraint, imported golang.org/x/sys/windows, replaced syscall.CREATE_NO_WINDOW with windows.CREATE_NO_WINDOW
- **Files modified:** internal/lifecycle/stopper.go
- **Verification:** go build ./... succeeds
- **Committed in:** 930c496 (separate fix commit)

---

**Total deviations:** 1 auto-fixed (1 blocking issue)
**Impact on plan:** Minimal - fixed pre-existing file that blocked compilation. No scope creep.

## Issues Encountered
None - plan executed smoothly after resolving the pre-existing stopper.go compilation issue.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Lifecycle detection infrastructure complete
- Ready for stop/start nanobot implementation (plans 02 and 03)
- Detector functions can be used to verify nanobot state before/after updates

---
*Phase: 01.1-nanobot-lifecycle-management-stop-before-update-start-after-update*
*Completed: 2026-02-18*

## Self-Check: PASSED
- internal/config/config.go: FOUND
- internal/lifecycle/detector.go: FOUND
- config.yaml: FOUND
- Commit 4330943: FOUND
- Commit f068ba1: FOUND
