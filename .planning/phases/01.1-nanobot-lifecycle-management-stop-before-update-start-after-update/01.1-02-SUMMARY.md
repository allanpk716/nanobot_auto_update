---
phase: 01.1-nanobot-lifecycle-management-stop-before-update-start-after-update
plan: 02
subsystem: lifecycle
tags: [windows, process-management, taskkill, hidden-window, port-verification]

# Dependency graph
requires:
  - phase: 01.1-01
    provides: Process detection via port listening check (FindProcessByPort)
provides:
  - StopNanobot function for graceful/forced process termination
  - StartNanobot function for hidden background process startup with port verification
affects: [updater, lifecycle]

# Tech tracking
tech-stack:
  added: [golang.org/x/sys/windows]
  patterns: [windows.SysProcAttr for hidden execution, CREATE_NO_WINDOW, CREATE_NEW_PROCESS_GROUP]

key-files:
  created: [internal/lifecycle/starter.go]
  modified: [internal/lifecycle/stopper.go]

key-decisions:
  - "Use windows.SysProcAttr instead of syscall.SysProcAttr for CREATE_NO_WINDOW support"
  - "Use taskkill command for process termination on Windows (SIGTERM does not work)"
  - "Use cmd.Start() + Release() for detached background process (not cmd.Run())"

patterns-established:
  - "Hidden execution: SysProcAttr with HideWindow:true and CREATE_NO_WINDOW flag"
  - "Process detachment: CREATE_NEW_PROCESS_GROUP flag + Process.Release()"
  - "Port verification: net.DialTimeout polling with deadline"

requirements-completed: [IMPL-02, IMPL-03, IMPL-04]

# Metrics
duration: 8min
completed: 2026-02-18
---

# Phase 01.1 Plan 02: Stopper and Starter Implementation Summary

**Implemented nanobot process lifecycle management with graceful stop via taskkill and hidden background startup with port verification**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-18T05:00:44Z
- **Completed:** 2026-02-18T05:08:44Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- StopNanobot function with graceful taskkill, 5-second timeout, and force-kill fallback
- StartNanobot function that starts nanobot gateway as hidden detached process
- Port verification via net.DialTimeout polling to confirm startup success
- Fixed Windows-specific compilation issue with syscall.SysProcAttr vs windows.SysProcAttr

## Task Commits

Each task was committed atomically:

1. **Task 1: Implement graceful stop with timeout and force kill fallback** - `8b1fca7` (fix)
2. **Task 2: Implement hidden background start with port verification** - `cd2b669` (feat)

## Files Created/Modified
- `internal/lifecycle/stopper.go` - Graceful/forced process termination using taskkill with hidden window
- `internal/lifecycle/starter.go` - Hidden background process startup with CREATE_NO_WINDOW | CREATE_NEW_PROCESS_GROUP flags

## Decisions Made
- Used windows.SysProcAttr (from golang.org/x/sys/windows) instead of syscall.SysProcAttr because CREATE_NO_WINDOW is only defined in the x/sys package
- Used taskkill command for Windows process termination as SIGTERM does not work on Windows
- Used cmd.Start() + Process.Release() for detached process execution (not cmd.Run() which waits)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed syscall.SysProcAttr to windows.SysProcAttr for CREATE_NO_WINDOW**
- **Found during:** Task 1 (Implement graceful stop with timeout)
- **Issue:** The plan's code used syscall.SysProcAttr with syscall.CREATE_NO_WINDOW, but CREATE_NO_WINDOW constant is not defined in the standard syscall package on Windows
- **Fix:** Changed to use golang.org/x/sys/windows package with windows.SysProcAttr and windows.CREATE_NO_WINDOW. Also changed syscall.Signal to windows.Signal for consistency.
- **Files modified:** internal/lifecycle/stopper.go
- **Verification:** `go build ./...` compiles successfully
- **Committed in:** 8b1fca7 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Bug fix was necessary for compilation on Windows. The golang.org/x/sys/windows package is the correct way to access Windows-specific constants.

## Issues Encountered
None - the only issue was the syscall.SysProcAttr incompatibility which was auto-fixed.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Stop and Start functions are ready for integration with the updater workflow
- Next plan (01.1-03) will integrate these functions into the update process

## Self-Check: PASSED
- internal/lifecycle/stopper.go: FOUND
- internal/lifecycle/starter.go: FOUND
- Task 1 commit 8b1fca7: FOUND
- Task 2 commit cd2b669: FOUND

---
*Phase: 01.1-nanobot-lifecycle-management-stop-before-update-start-after-update*
*Completed: 2026-02-18*
