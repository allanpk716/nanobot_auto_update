# Phase 01.1: Nanobot 生命周期管理 - Context

**Gathered:** 2025-02-18
**Status:** Ready for planning

<domain>
## Phase Boundary

在执行 nanobot 更新之前停止运行中的 nanobot 进程，更新完成后重新启动它。确保更新过程不会因为文件被占用而失败，同时保持 nanobot 服务的高可用性。

</domain>

<decisions>
## Implementation Decisions

### 进程检测
- 通过检测端口监听状态判断 nanobot 是否运行
- 默认检测端口 18790
- 端口号可在配置文件中自定义

### 停止行为
- 优雅停止 + 超时强制终止
- 先发送终止信号等待进程正常退出
- 超时时间：5 秒，超时后强制终止进程

### 启动行为
- 更新后总是启动 nanobot（不管更新前是否运行）
- 启动命令：`nanobot gateway`
- 完全静默启动，不显示控制台窗口
- 使用系统默认目录启动
- 不需要额外的命令行参数
- 通过检查端口监听确认启动成功
- 启动超时时间可配置

### 失败处理
- 停止失败：取消本次更新，记录错误日志
- 启动失败：更新仍然视为成功，记录错误日志（用户可手动启动）

### 日志记录
- 记录所有操作的时间戳
- 记录执行的命令及返回结果
- 记录端口状态和进程 ID
- 停止/启动失败时记录详细错误信息（包含错误码）

### 配置结构
- nanobot 相关配置放在独立 section 中
- 配置项包括：端口、启动超时时间等

### Claude's Discretion
- 具体的进程终止信号选择（SIGTERM/SIGKILL 等）
- 端口检测的具体实现方式
- 日志格式细节

</decisions>

<specifics>
## Specific Ideas

- nanobot 默认使用 18790 端口
- 启动命令固定为 `nanobot gateway`
- 保持与 Phase 1 的一致性：静默执行命令，不弹出控制台窗口

</specifics>

<deferred>
## Deferred Ideas

None — 讨论保持在阶段范围内

</deferred>

---

*Phase: 01.1-nanobot-lifecycle-management-stop-before-update-start-after-update*
*Context gathered: 2025-02-18*
