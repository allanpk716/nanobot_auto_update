---
phase: 02-core-update-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/updater/checker.go
  - internal/updater/checker_test.go
autonomous: true
requirements:
  - UPDT-01
  - UPDT-02
user_setup: []

must_haves:
  truths:
    - "Program exits with clear error message if uv is not installed on the system"
    - "Program starts successfully if uv is installed in PATH"
    - "User receives helpful guidance on how to install uv when missing"
  artifacts:
    - path: "internal/updater/checker.go"
      provides: "UV installation verification"
      exports: ["CheckUvInstalled"]
      min_lines: 25
    - path: "internal/updater/checker_test.go"
      provides: "Test coverage for checker"
      contains: "TestCheckUvInstalled"
  key_links:
    - from: "cmd/main.go"
      to: "internal/updater.CheckUvInstalled"
      via: "import and call at startup"
      pattern: "updater\\.CheckUvInstalled"
---

<objective>
Create UV installation checker that verifies uv package manager is available before attempting updates.

Purpose: Ensure uv is installed on the system before any update operations, providing clear error messages if missing.
Output: internal/updater/checker.go with CheckUvInstalled function and tests.
</objective>

<execution_context>
@C:/Users/allan716/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/allan716/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-update-logic/02-RESEARCH.md

# Reference existing patterns
@internal/lifecycle/stopper.go - Windows build constraint and SysProcAttr pattern
@internal/lifecycle/starter.go - Hidden window pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UV installation checker package</name>
  <files>internal/updater/checker.go</files>
  <action>
Create a new package `internal/updater` with `checker.go` that implements UV installation verification:

1. Create directory `internal/updater/` if not exists
2. Create `checker.go` with:
   - Build constraint: `//go:build windows`
   - Package: `updater`
   - Function `CheckUvInstalled() error`:
     - Uses `exec.LookPath("uv")` to check if uv is in PATH
     - Returns `fmt.Errorf("uv is not installed or not in PATH - please install uv from https://docs.astral.sh/uv/")` if `exec.ErrNotFound`
     - Wraps other errors with context: `fmt.Errorf("failed to check for uv installation: %w", err)`
     - Returns `nil` if uv is found

Use the pattern from RESEARCH.md Pattern 1. Import: errors, fmt, os/exec.

Do NOT implement update logic in this file - only the checker function.
</action>
  <verify>
Run: `go build ./internal/updater`
Expected: Compiles without errors
  </verify>
  <done>
- internal/updater/checker.go exists with CheckUvInstalled function
- Function uses exec.LookPath correctly
- Error messages are clear and actionable
- Build constraint //go:build windows is present
  </done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for checker</name>
  <files>internal/updater/checker_test.go</files>
  <action>
Create `checker_test.go` with unit tests:

1. Test `TestCheckUvInstalled`:
   - Call `CheckUvInstalled()` - should pass if uv is installed on dev machine
   - Log the result (don't fail if uv not installed on test machine)

2. Test `TestCheckUvInstalledErrorMessage`:
   - Verify error message contains "uv is not installed" for ErrNotFound case
   - Can mock by creating a test that checks the error string format

Keep tests simple - just verify the function works and returns appropriate errors.
</action>
  <verify>
Run: `go test ./internal/updater -v`
Expected: Tests pass or skip gracefully if uv not installed
  </verify>
  <done>
- internal/updater/checker_test.go exists
- Tests verify CheckUvInstalled behavior
- Test output is meaningful
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate UV check into main.go startup</name>
  <files>cmd/main.go</files>
  <action>
Modify `cmd/main.go` to check UV installation at startup:

1. Add import: `"github.com/HQGroup/nanobot-auto-updater/internal/updater"`
2. After logger initialization and BEFORE any update logic:
   ```go
   // Check UV installation
   logger.Info("Checking uv installation")
   if err := updater.CheckUvInstalled(); err != nil {
       logger.Error("uv installation check failed", "error", err.Error())
       fmt.Fprintf(os.Stderr, "Error: %v\n", err)
       os.Exit(1)
   }
   logger.Info("uv is installed and available")
   ```
3. Place this after line 65 (after slog.SetDefault(logger))
4. Remove or update the TODO comment about Phase 2
</action>
  <verify>
Run: `go build ./cmd && ./nanobot-auto-updater --version`
Expected: Exits cleanly with version if uv installed, or clear error if not
  </verify>
  <done>
- main.go imports updater package
- UV check happens at startup after logger init
- Program exits with clear error if uv not installed
- Error is logged before exit
  </done>
</task>

</tasks>

<verification>
1. Build check: `go build ./...` passes
2. Test check: `go test ./internal/updater -v` passes
3. Integration check: Running `go run ./cmd/main.go --version` shows uv check in logs
4. Error case: Temporarily modify LookPath to return ErrNotFound and verify exit code is 1
</verification>

<success_criteria>
- CheckUvInstalled function exists and works correctly
- Program exits with error code 1 if uv not installed
- Error message includes installation guidance URL
- Unit tests provide coverage
- Integration with main.go is complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-update-logic/02-01-SUMMARY.md`
</output>
