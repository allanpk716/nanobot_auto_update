---
phase: 03-scheduling-and-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - internal/notifier/notifier.go
  - internal/notifier/notifier_test.go
autonomous: true
requirements:
  - NOTF-01
  - NOTF-02
  - NOTF-03
  - NOTF-04

user_setup:
  - service: Pushover
    why: "Failure notification delivery"
    env_vars:
      - name: PUSHOVER_TOKEN
        source: "Pushover Dashboard -> Your Applications -> Application API Token"
      - name: PUSHOVER_USER
        source: "Pushover Dashboard -> Your User Key"

must_haves:
  truths:
    - "User receives Pushover notification when update fails"
    - "Notification includes the failure reason"
    - "Program runs without Pushover configuration (logs warning instead of failing)"
    - "Missing Pushover env vars are logged at startup"
  artifacts:
    - path: "internal/notifier/notifier.go"
      provides: "Notifier with Pushover implementation and graceful missing config"
      contains: "os.Getenv"
      min_lines: 80
    - path: "internal/notifier/notifier_test.go"
      provides: "Unit tests for notifier"
      exports: ["TestNew", "TestNew_MissingEnv", "TestNotify"]
  key_links:
    - from: "internal/notifier/notifier.go"
      to: "os"
      via: "os.Getenv for PUSHOVER_TOKEN and PUSHOVER_USER"
      pattern: "os\\.Getenv\\(\"PUSHOVER_"
    - from: "internal/notifier/notifier.go"
      to: "gregdel/pushover"
      via: "import and pushover.New()"
      pattern: "pushover\\.New\\(token\\)"
---

<objective>
Create notifier package that reads Pushover config from environment variables and sends failure notifications.

Purpose: Enable failure notifications via Pushover API, with graceful handling when configuration is missing.
Output: internal/notifier/notifier.go and notifier_test.go
</objective>

<execution_context>
@C:/Users/allan716/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/allan716/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scheduling-and-notifications/03-RESEARCH.md

# Existing patterns to follow
@internal/logging/logging.go - Logger creation pattern
@internal/updater/updater.go - Struct with logger field pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install gregdel/pushover dependency and create Notifier struct</name>
  <files>go.mod, go.sum, internal/notifier/notifier.go</files>
  <action>
Install Pushover library and create the notifier package:

1. Run `go get github.com/gregdel/pushover@latest` to add the dependency

2. Create `internal/notifier/notifier.go` with:
   - Notifier struct holding:
     - client *pushover.Pushover
     - recipient *pushover.Recipient
     - logger *slog.Logger
     - enabled bool
   - New(logger *slog.Logger) *Notifier function that:
     - Reads PUSHOVER_TOKEN and PUSHOVER_USER via os.Getenv()
     - If either is empty:
       - Logs WARN: "Pushover notifications disabled" with reason and hint
       - Returns &Notifier{enabled: false, logger: logger}
     - If both are set:
       - Logs INFO: "Pushover notifications enabled"
       - Creates pushover.New(token) and pushover.NewRecipient(user)
       - Returns &Notifier with client, recipient, logger, enabled: true
   - IsEnabled() bool method
   - Notify(title, message string) error method that:
     - Returns nil immediately if !n.enabled (no error)
     - Creates message with pushover.NewMessageWithTitle(message, title)
     - Calls n.client.SendMessage(msg, n.recipient)
     - Logs INFO with response.ID on success
     - Returns wrapped error on failure
   - NotifyFailure(operation string, err error) error method that:
     - Formats title as "Nanobot Update Failed: {operation}"
     - Formats message as "Operation: {operation}\n\nError: {err}"
     - Calls n.Notify(title, message)

3. CRITICAL: DO NOT fail if env vars are missing - log warning and continue (NOTF-04)

4. Pattern from RESEARCH.md Pattern 2 - exact implementation provided

5. No build constraint needed - notifier works on all platforms
  </action>
  <verify>go build ./internal/notifier/...</verify>
  <done>Notifier struct compiles with New/Notify/NotifyFailure methods, graceful missing config handling</done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for notifier</name>
  <files>internal/notifier/notifier_test.go</files>
  <action>
Create unit tests in `internal/notifier/notifier_test.go`:

1. TestNew_MissingEnv - Verify disabled notifier when env vars missing:
   - Ensure PUSHOVER_TOKEN and PUSHOVER_USER are not set
   - Create notifier
   - Verify notifier.IsEnabled() returns false

2. TestNew_WithEnv - Verify enabled notifier when env vars set:
   - Set PUSHOVER_TOKEN and PUSHOVER_USER via os.Setenv
   - Defer os.Unsetenv cleanup
   - Create notifier
   - Verify notifier.IsEnabled() returns true

3. TestNotify_Disabled - Verify no error when disabled:
   - Create notifier without env vars (disabled)
   - Call Notify("title", "message")
   - Verify returns nil (no error)

4. TestNotifyFailure - Verify message formatting:
   - This test verifies the title/message format logic
   - Can be a simple unit test checking the formatted strings match expected patterns
   - Note: Actual Pushover API calls require real credentials (skip in CI)

5. Use t.Setenv() for environment variable tests where available (Go 1.17+)

6. Skip tests that require actual Pushover API calls unless integration flag is set

7. Pattern from existing tests:
   - Create test logger using logging.NewLogger or discard handler
   - Focus on logic verification, not API calls
  </action>
  <verify>go test ./internal/notifier/... -v</verify>
  <done>All tests pass, code coverage includes New with both env cases, Notify, NotifyFailure</done>
</task>

</tasks>

<verification>
Phase 3 Plan 02 verification:
1. Run `go build ./internal/notifier/...` - must compile
2. Run `go test ./internal/notifier/... -v` - all tests pass
3. Verify go.mod contains github.com/gregdel/pushover
4. Verify notifier.go uses os.Getenv for PUSHOVER_TOKEN and PUSHOVER_USER
5. Verify notifier logs warning (not error) when env vars missing
</verification>

<success_criteria>
- [ ] gregdel/pushover added to go.mod
- [ ] internal/notifier/notifier.go exists with Notifier struct
- [ ] New() reads PUSHOVER_TOKEN and PUSHOVER_USER from environment
- [ ] New() logs warning and returns disabled notifier if env vars missing
- [ ] Notify() returns nil when disabled (graceful degradation)
- [ ] NotifyFailure() formats title and message correctly
- [ ] Unit tests pass for all scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/03-scheduling-and-notifications/03-02-SUMMARY.md`
</output>
